<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="fragments/head :: head"></head>
<body>
    <header th:replace="fragments/header :: header"></header>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 th:text="${bundle.bundleTitle}">번들 제목</h2>
                    </div>
                    <div class="card-body">
                        <p th:text="${bundle.bundleDescription}">번들 설명</p>
                        <p>업로드 날짜: <span th:text="${#temporals.format(bundle.uploadedAt, 'yyyy-MM-dd HH:mm')}"></span></p>
                        <p>번들 이름: <span th:text="${bundle.bundleName}"></span></p>
                        <p>좋아요 수: <span id="likeCount" th:text="${likeCount}"></span></p>

                        <button id="likeButton" class="btn" th:classappend="${isLiked} ? 'btn-danger' : 'btn-outline-danger'">
                            <span th:text="${isLiked} ? '좋아요 취소' : '좋아요'"></span>
                        </button>
                    </div>
                </div>

                <!-- 게시글 섹션 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>게시글</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${post}">
                            <p>작성자: <span th:text="${post.author.username}"></span></p>
                            <p th:text="${post.content}"></p>
                            <a th:href="@{/posts/{postId}(postId=${post.postId})}" class="btn btn-info">게시글 보기</a>
                        </div>
                        <div th:unless="${post}">
                            <p>아직 게시글이 없습니다. 첫 게시글을 작성해주세요!</p>
                            <form id="postForm" method="post" action="/posts">
                                <input type="hidden" name="assetBundleId" th:value="${bundle.id}">
                                <div class="form-group">
                                    <label for="postContent">게시글 내용:</label>
                                    <textarea class="form-control" id="postContent" name="content" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">게시글 작성</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const bundleId = [[${bundle.id}]];
        const likeButton = document.getElementById('likeButton');
        const likeCountSpan = document.getElementById('likeCount');
        const postForm = document.getElementById('postForm');

        likeButton.addEventListener('click', async () => {
            const response = await fetch(`/api/assetbundles/${bundleId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            if (response.ok) {
                const isLiked = likeButton.classList.toggle('btn-danger');
                likeButton.classList.toggle('btn-outline-danger');
                let currentLikes = parseInt(likeCountSpan.textContent);
                if (isLiked) {
                    likeCountSpan.textContent = currentLikes + 1;
                    likeButton.querySelector('span').textContent = '좋아요 취소';
                } else {
                    likeCountSpan.textContent = currentLikes - 1;
                    likeButton.querySelector('span').textContent = '좋아요';
                }
            } else if (response.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
            } else {
                alert('좋아요 처리 중 오류가 발생했습니다.');
            }
        });

        if (postForm) {
            postForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(postForm);
                const response = await fetch('/posts', {
                    method: 'POST',
                    body: new URLSearchParams(formData).toString(),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                if (response.ok) {
                    alert('게시글이 작성되었습니다.');
                    window.location.reload();
                } else if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                } else {
                    alert('게시글 작성 중 오류가 발생했습니다.');
                }
            });
        }
    </script>
</body>
</html>
